version: "3.8"

# Native Rollup Dual-Chain Stack
# L1 (Gnosis fork) + L2 (fresh chain) + Sequencer + Block Explorer
#
# Ports chosen to not conflict with existing Surge stack:
#   L1 Anvil:           9545
#   L2 Anvil:           9546
#   Blockscout API:     9010
#   Blockscout UI:      9000

services:
  # L1: Gnosis Chain fork at a block after NativeRollupCore deployment
  l1-anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    entrypoint: anvil
    command: >
      --fork-url https://rpc.gnosischain.com
      --fork-block-number 44315000
      --chain-id 100
      --host 0.0.0.0
      --port 8545
      --compute-units-per-second 50
    ports:
      - "9545:8545"
    healthcheck:
      test: ["CMD", "cast", "block-number", "--rpc-url", "http://localhost:8545"]
      interval: 5s
      timeout: 3s
      retries: 10

  # L2: Fresh EVM chain (the rollup)
  # No --block-time: blocks are only mined when transactions arrive (on-demand).
  # The sequencer is the sole source of L2 transactions, driven by L1 events.
  l2-anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    entrypoint: anvil
    command: >
      --chain-id 10200200
      --host 0.0.0.0
      --port 8545
    ports:
      - "9546:8545"
    healthcheck:
      test: ["CMD", "cast", "block-number", "--rpc-url", "http://localhost:8545"]
      interval: 5s
      timeout: 3s
      retries: 10

  # Sequencer: Watches L1 events, replays on L2
  sequencer:
    build:
      context: ./sequencer
      dockerfile: Dockerfile
    environment:
      L1_RPC: http://l1-anvil:8545
      L2_RPC: http://l2-anvil:8545
      ROLLUP_ADDRESS: "0x4240994d85109581B001183ab965D9e3d5fb2C2A"
      ADMIN_KEY: "0xf2024347d89be67338b62344010fb2ebc5db60cad2ff591a92a30b8215f87f22"
    depends_on:
      l1-anvil:
        condition: service_healthy
      l2-anvil:
        condition: service_healthy
    restart: unless-stopped

  # Block Explorer for L2
  blockscout-db:
    image: postgres:15
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_USER: blockscout
      POSTGRES_DB: blockscout
    volumes:
      - ss-blockscout-db-data:/var/lib/postgresql/data

  blockscout:
    image: blockscout/blockscout:latest
    command: sh -c "bin/blockscout eval \"Elixir.Explorer.ReleaseTasks.create_and_migrate()\" && bin/blockscout start"
    environment:
      ETHEREUM_JSONRPC_VARIANT: geth
      ETHEREUM_JSONRPC_HTTP_URL: http://l2-anvil:8545
      ETHEREUM_JSONRPC_TRACE_URL: http://l2-anvil:8545
      DATABASE_URL: postgresql://blockscout:postgres@blockscout-db:5432/blockscout
      CHAIN_ID: "10200200"
      COIN: ETH
      NETWORK: "Native Rollup L2"
      SUBNETWORK: "Synchronous Surge"
      ECTO_USE_SSL: "false"
      SECRET_KEY_BASE: "56NtB48ear7+wMSf0IQuWDAAazhpb31qyc7GiyspBP2vh7t5zlCsF5QDv76chXeN"
      PORT: "4000"
      DISABLE_WEBAPP: "false"
      API_V2_ENABLED: "true"
      INDEXER_DISABLE_PENDING_TRANSACTIONS_FETCHER: "true"
    ports:
      - "9010:4000"
    depends_on:
      - blockscout-db
      - l2-anvil
    restart: unless-stopped

  # Blockscout Frontend (Next.js UI)
  blockscout-frontend:
    image: ghcr.io/blockscout/frontend:latest
    environment:
      PORT: "3000"
      NEXT_PUBLIC_NETWORK_ID: "10200200"
      NEXT_PUBLIC_NETWORK_NAME: "Synchronous Surge L2"
      NEXT_PUBLIC_NETWORK_SHORT_NAME: "Surge L2"
      NEXT_PUBLIC_NETWORK_RPC_URL: http://localhost:9546
      NEXT_PUBLIC_APP_PROTOCOL: http
      NEXT_PUBLIC_APP_HOST: localhost
      NEXT_PUBLIC_APP_PORT: "9000"
      NEXT_PUBLIC_API_PROTOCOL: http
      NEXT_PUBLIC_API_HOST: localhost
      NEXT_PUBLIC_API_PORT: "9010"
      NEXT_PUBLIC_API_BASE_PATH: /
      NEXT_PUBLIC_USE_NEXT_JS_PROXY: "false"
      NEXT_PUBLIC_IS_TESTNET: "true"
      NEXT_PUBLIC_HAS_BEACON_CHAIN: "false"
      NEXT_PUBLIC_AD_BANNER_PROVIDER: none
      NEXT_PUBLIC_AD_TEXT_PROVIDER: none
      NEXT_PUBLIC_GAS_TRACKER_ENABLED: "true"
      NEXT_PUBLIC_NETWORK_VERIFICATION_TYPE: validation
      HOSTNAME: 0.0.0.0
    ports:
      - "9000:3000"
    depends_on:
      - blockscout
    restart: unless-stopped

volumes:
  ss-blockscout-db-data:
