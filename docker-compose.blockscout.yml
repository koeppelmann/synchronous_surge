# Blockscout instances for local testnet
# Usage:
#   L1_RPC_PORT=8545 L2_RPC_PORT=9546 docker compose -f docker-compose.blockscout.yml up -d

services:
  # ============ L1 Blockscout ============
  l1-proxy:
    image: nginx:alpine
    container_name: blockscout-l1-proxy
    depends_on:
      - l1-frontend
      - l1-backend
    volumes:
      - ./nginx-l1.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "3100:80"

  l1-postgres:
    image: postgres:15
    container_name: blockscout-l1-postgres
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_USER: postgres
      POSTGRES_DB: blockscout
    ports:
      - "5500:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  l1-backend:
    image: blockscout/blockscout:latest
    container_name: blockscout-l1-backend
    command: /bin/sh -c "bin/blockscout eval 'Elixir.Explorer.ReleaseTasks.create_and_migrate()' && bin/blockscout start"
    depends_on:
      l1-postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://postgres:postgres@l1-postgres:5432/blockscout
      ECTO_USE_SSL: "false"
      ETHEREUM_JSONRPC_VARIANT: geth
      ETHEREUM_JSONRPC_HTTP_URL: http://host.docker.internal:${L1_RPC_PORT:-8545}
      ETHEREUM_JSONRPC_TRACE_URL: http://host.docker.internal:${L1_RPC_PORT:-8545}
      CHAIN_ID: 31337
      COIN: ETH
      NETWORK: L1
      SUBNETWORK: L1 Local Testnet
      API_V2_ENABLED: "true"
      DISABLE_EXCHANGE_RATES: "true"
      DISABLE_KNOWN_TOKENS: "true"
      INDEXER_DISABLE_INTERNAL_TRANSACTIONS_FETCHER: "true"
      INDEXER_DISABLE_PENDING_TRANSACTIONS_FETCHER: "true"
      FETCH_REWARDS_WAY: manual
      MIX_ENV: prod
      SECRET_KEY_BASE: RMgI4C1HSkxsEjdhtGMfwAHfyT6CKWXOgzCboJflfSm4jeAlic52io05KB6mqzc5
    ports:
      - "4100:4000"
    extra_hosts:
      - "host.docker.internal:host-gateway"

  l1-frontend:
    image: ghcr.io/blockscout/frontend:latest
    container_name: blockscout-l1-frontend
    depends_on:
      - l1-backend
    environment:
      NEXT_PUBLIC_APP_HOST: localhost
      NEXT_PUBLIC_APP_PORT: 3100
      NEXT_PUBLIC_APP_PROTOCOL: http
      NEXT_PUBLIC_API_HOST: localhost
      NEXT_PUBLIC_API_PORT: 3100
      NEXT_PUBLIC_API_PROTOCOL: http
      NEXT_PUBLIC_API_BASE_PATH: /
      NEXT_PUBLIC_NETWORK_NAME: L1 Local Testnet
      NEXT_PUBLIC_NETWORK_SHORT_NAME: L1
      NEXT_PUBLIC_NETWORK_ID: 31337
      NEXT_PUBLIC_NETWORK_CURRENCY_NAME: Ether
      NEXT_PUBLIC_NETWORK_CURRENCY_SYMBOL: ETH
      NEXT_PUBLIC_NETWORK_CURRENCY_DECIMALS: 18
      NEXT_PUBLIC_IS_TESTNET: "true"
      NEXT_PUBLIC_API_WEBSOCKET_PROTOCOL: ws
      NEXT_PUBLIC_HOMEPAGE_CHARTS: "['daily_txs']"
    expose:
      - "3000"

  # ============ L2 Blockscout ============
  l2-proxy:
    image: nginx:alpine
    container_name: blockscout-l2-proxy
    depends_on:
      - l2-frontend
      - l2-backend
    volumes:
      - ./nginx-l2.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "3101:80"

  l2-postgres:
    image: postgres:15
    container_name: blockscout-l2-postgres-local
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_USER: postgres
      POSTGRES_DB: blockscout
    ports:
      - "5501:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  l2-backend:
    image: blockscout/blockscout:latest
    container_name: blockscout-l2-backend
    command: /bin/sh -c "bin/blockscout eval 'Elixir.Explorer.ReleaseTasks.create_and_migrate()' && bin/blockscout start"
    depends_on:
      l2-postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://postgres:postgres@l2-postgres:5432/blockscout
      ECTO_USE_SSL: "false"
      ETHEREUM_JSONRPC_VARIANT: geth
      ETHEREUM_JSONRPC_HTTP_URL: http://host.docker.internal:${L2_RPC_PORT:-9546}
      ETHEREUM_JSONRPC_TRACE_URL: http://host.docker.internal:${L2_RPC_PORT:-9546}
      CHAIN_ID: 10200200
      COIN: ETH
      NETWORK: L2
      SUBNETWORK: L2 Native Rollup
      API_V2_ENABLED: "true"
      DISABLE_EXCHANGE_RATES: "true"
      DISABLE_KNOWN_TOKENS: "true"
      INDEXER_DISABLE_INTERNAL_TRANSACTIONS_FETCHER: "true"
      INDEXER_DISABLE_PENDING_TRANSACTIONS_FETCHER: "true"
      FETCH_REWARDS_WAY: manual
      MIX_ENV: prod
      SECRET_KEY_BASE: RMgI4C1HSkxsEjdhtGMfwAHfyT6CKWXOgzCboJflfSm4jeAlic52io05KB6mqzc5
    ports:
      - "4101:4000"
    extra_hosts:
      - "host.docker.internal:host-gateway"

  l2-frontend:
    image: ghcr.io/blockscout/frontend:latest
    container_name: blockscout-l2-frontend-local
    depends_on:
      - l2-backend
    environment:
      NEXT_PUBLIC_APP_HOST: localhost
      NEXT_PUBLIC_APP_PORT: 3101
      NEXT_PUBLIC_APP_PROTOCOL: http
      NEXT_PUBLIC_API_HOST: localhost
      NEXT_PUBLIC_API_PORT: 3101
      NEXT_PUBLIC_API_PROTOCOL: http
      NEXT_PUBLIC_API_BASE_PATH: /
      NEXT_PUBLIC_NETWORK_NAME: L2 Native Rollup
      NEXT_PUBLIC_NETWORK_SHORT_NAME: L2
      NEXT_PUBLIC_NETWORK_ID: 10200200
      NEXT_PUBLIC_NETWORK_CURRENCY_NAME: Ether
      NEXT_PUBLIC_NETWORK_CURRENCY_SYMBOL: ETH
      NEXT_PUBLIC_NETWORK_CURRENCY_DECIMALS: 18
      NEXT_PUBLIC_IS_TESTNET: "true"
      NEXT_PUBLIC_API_WEBSOCKET_PROTOCOL: ws
      NEXT_PUBLIC_HOMEPAGE_CHARTS: "['daily_txs']"
    expose:
      - "3000"
